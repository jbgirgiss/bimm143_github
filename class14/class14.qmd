---
title: "Class 14: RNASeq mini project"
author: "Joseph Girgiss (PID: A17388247)"
format: pdf
toc: true
---

## Background

Here we work through a complete RNASeq analysis project. The input data comes from a knock-down experiment of a HOX gene. 

## Data Import

Reading the `counts` and `metadata` csv files
Check on data structure 

```{r}
counts <- read.csv("GSE37704_featurecounts.csv", row.names = 1, )
metadata <- read.csv("GSE37704_metadata.csv")

head(counts)
head(metadata)
```

Some book-keeping is required as there looks to be a mis-match between counts columns and metadata rows.  
```{r}
ncol(counts)
nrow(metadata)
```
Looks like we need to get rid of the first "length" column of our `counts` object. 

```{r}
cleancounts <- counts[, -1]
head(cleancounts)
ncol(cleancounts)
```

### Remove zero count genes

There are lots of genes with zero counts. We can remove these for future analysis.

```{r}
to.keep.inds <- rowSums(cleancounts) > 0
nonzero_counts <- cleancounts[to.keep.inds,]
```

## DESeq Analysis

Load the package

```{r, message = FALSE}
library(DESeq2)
```

Setup DESeq object

```{r}
dds <- DESeqDataSetFromMatrix(countData = nonzero_counts, 
                              colData = metadata, 
                              design = ~condition)
```

Run DESeq
```{r}
dds <- DESeq(dds)
```

Get results

```{r}
res <- results(dds)
head(res)
```

Summary of results: 
```{r}
summary(res)
```

## Data Visualization

Volcano plot

```{r}
library(ggplot2)

ggplot(res) + 
  aes(log2FoldChange, -log(padj)) +
        geom_point() + 
  theme_bw()

plot( res$log2FoldChange, -log(res$padj) )
```

Add threshfold lines for fold-change and P-value and color our subset of genes that makes these threshold cut-offs in the plot. 

```{r}

# Setup our custom point color vector 
mycols <- rep("gray", nrow(res))
mycols[ abs(res$log2FoldChange) > 2 ]  <- "red" 

inds <- (res$padj < 0.01) & (abs(res$log2FoldChange) > 2 )
mycols[ inds ] <- "blue"

# Volcano plot with custom colors 
plot( res$log2FoldChange,  -log(res$padj), 
 col=mycols, xlab="Log2(FoldChange)", ylab="-Log(P-value)")

# Cut-off lines
abline(v=c(-2,2), col="gray", lty=2)
abline(h=-log(0.01), col="gray", lty=2)
```


## Add Annotation

Add gene symbols and entrez ids

```{r}
library(AnnotationDbi)
library(org.Hs.eg.db)
```

```{r, message = FALSE}
res$entrez <- mapIds(keys = row.names(res), # our current Ids
       keytype = "ENSEMBL" ,  # the format of our Ids
       x = org.Hs.eg.db,      # where to get the mappings from 
       column = "ENTREZID"      # the format/DB to map to 
      )

res$symbol <- mapIds(keys = row.names(res), # our current Ids
       keytype = "ENSEMBL" ,  # the format of our Ids
       x = org.Hs.eg.db,      # where to get the mappings from 
       column = "SYMBOL"      # the format/DB to map to 
      )

res$GENENAME <- mapIds(keys = row.names(res), # our current Ids
       keytype = "ENSEMBL" ,  # the format of our Ids
       x = org.Hs.eg.db,      # where to get the mappings from 
       column = "GENENAME"      # the format/DB to map to 
      )
head(res)
```

## Pathway Analysis

### Kegg pathway analysis
Run gage analysis

```{r, message = FALSE}
library(gage)
library(gageData)
library(pathview)
```

We need a named vector of fold-change values as inputs for gage. 
```{r}
foldchanges <- res$log2FoldChange
names(foldchanges) <- res$entrez
head(foldchanges)
```

```{r}
data(kegg.sets.hs)

keggres = gage(foldchanges, gsets=kegg.sets.hs)
```

```{r}
head(keggres$less, 2)
```

```{r}
pathview(pathway.id = "hsa04110", gene.data = foldchanges)
pathview(pathway.id = "hsa03030", gene.data = foldchanges)
```

![](hsa04110.pathview.png)

![](hsa03030.pathview.png)


>Q. Can you do the same procedure as above to plot the pathview figures for the top 5 down-regulated pathways?

hsa04110 and hsa03030 are seen above

```{r}
## Focus on top 5 down-regulated pathways 
keggrespathways <- rownames(keggres$less)[1:5]

# Extract the 8 character long IDs part of each string
keggresids = substr(keggrespathways, start=1, stop=8)
keggresids
```

```{r}
pathview(gene.data=foldchanges, pathway.id=keggresids, species="hsa")
```

![](hsa05130.pathview.png)

![](hsa03013.pathview.png)

![](hsa03440.pathview.png)

### GO terms

Same analysis but using GO genesets rather than KEGG
```{r}
data(go.sets.hs)
data(go.subs.hs)

# Focus on Biological Process subset of GO
gobpsets = go.sets.hs[go.subs.hs$BP]

gobpres = gage(foldchanges, gsets=gobpsets, same.dir=TRUE)
```


```{r}
head(gobpres$less)
```

### Reactome Analysis

Lots of folks like the reactome web interface. We can also run this as an R function but lets look at the web interface first <https://reactome.org/PathwayBrowser/#TOOL=AT >

The website wants a text file with one gene symbol per line of the genes you want to map to pathways. 

```{r}
sig_genes <- res[res$padj <= 0.05 & !is.na(res$padj), "symbol"]
head(sig_genes)
print(paste("Total number of significant genes:", length(sig_genes)))
```

```{r}
write.table(sig_genes, file="significant_genes.txt", row.names=FALSE, col.names=FALSE, quote=FALSE)
```

> Q. What pathway has the most significant “Entities p-value”? Do the most significant pathways listed match your previous KEGG results? What factors could cause differences between the two methods?

```{r}
# Top KEGG upregulated pathway (lowest p-value)
kegg_top_up <- rownames(keggres$greater)[ which.min(keggres$greater[ , "p.val"]) ]

# Top KEGG downregulated pathway (lowest p-value)
kegg_top_down <- rownames(keggres$less)[ which.min(keggres$less[ , "p.val"]) ]

kegg_top_up
kegg_top_down

# Top GO BP upregulated term
go_top_up <- rownames(gobpres$greater)[ which.min(gobpres$greater[ , "p.val"]) ]

# Top GO BP downregulated term
go_top_down <- rownames(gobpres$less)[ which.min(gobpres$less[ , "p.val"]) ]

go_top_up
go_top_down

```

```{r}
top_up_pval <- head(rownames(keggres$greater),1) 
top_down_pval <- head(rownames(keggres$less), 1) 
top_up_pval 
top_down_pval 
go_top_up_pval <- head(rownames(gobpres$greater),1) 
go_top_down_pval <- head(rownames(gobpres$less), 1) 
go_top_up_pval 
go_top_down_pval
```
Cytokine-cytokine receptor interaction and homophilic cell adhesion are the most significant up-regulated gene for Kegg and for Go, respectively. Cell cycle and organelle fission are the most significant down-regulated gene for Kegg and for Go, respectively. While both the up-regulated gene reflect enhanced cell–cell communication and coordinated cellular responses, and both the down-regulated genes are related to cell-cycle progression, differences in gene "hits" may arise from differences in how each method categorizes biology (Kegg = general pathway, GO = function-based) as well as different gene set sizes. 

## Save our results

```{r}
res = res[order(res$pvalue),]
write.csv(res, file = "myresults.csv")
```

